# 07 Node.jsサーバー廃止・切り替え計画メモ

このファイルは、`docs/workers/todo-rust-migration.md` の「5. サーバー側（Node.js → Rust Worker/DO）の廃止ステップ」に対応する詳細メモです。

## 5.1 完全移行の判定条件

- 条件を満たしたとき「Node.js WebSocket サーバーを停止してよい」と判断する:
  - すべての `ClientMessage.action` が DO 側実装に移行済みであること。
  - すべての `ServerMessage.type` が Workers/DO 側から送信されるようになっていること。
  - E2E テストが Workers/DO を前提にした環境でグリーンになること。
  - 本番環境で一定期間（例: 数日〜1週間）Workers/DO で安定稼働していること。

## 5.2 段階的削除ステップ

1. **参照専用フェーズ**
   - `src/server/` 以下のコードは「仕様の参照用」として残し、新規機能追加はすべて Workers/DO 側に行う。
   - ドキュメント（設計書）上で「ソースオブトゥルースは Workers/DO 側」であることを明記。

2. **移行完了確認フェーズ**
   - `docs/workers/notes/05-message-mapping.md` を使って、全メッセージが新構成にマッピングされているか確認。
   - 旧サーバーを起動しなくてもテストが通ることを確認。

3. **コード削除フェーズ**
   - `src/server/` 以下をアーカイブブランチ or 別リポジトリに退避したうえで、本ブランチから削除。
   - `package.json` の `ws` 依存やサーバー起動スクリプトを整理。

## 5.3 テスト・監視の切り替え

- テスト:
  - 旧サーバー向けのユニット/統合テストのうち、有用なロジックは DO/Worker 向けテストとして再構成。
  - 「Nodeサーバーが起動していること」を前提としたテストは、Workers/DO 環境を前提とするよう変更。

- 監視/ログ:
  - Node サーバーログ → Workers/DO ログ（Cloudflare側のログ・メトリクス）への切り替え。
  - エラー率・レイテンシ・同時接続など、今後見るべき指標を整理しておく。


