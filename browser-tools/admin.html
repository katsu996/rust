<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†ç”»é¢ - ãƒ«ãƒ¼ãƒ ç®¡ç†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            color: #2c3e50;
        }

        .controls {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #2980b9;
        }

        button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }

        label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        input[type="number"] {
            width: 60px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .rooms-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .rooms-table {
            width: 100%;
            border-collapse: collapse;
        }

        .rooms-table th {
            background-color: #ecf0f1;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #bdc3c7;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .rooms-table td {
            padding: 12px;
            border-bottom: 1px solid #ecf0f1;
            vertical-align: middle;
        }

        .rooms-table td.room-id {
            font-family: monospace;
            font-size: 12px;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .rooms-table tr:hover {
            background-color: #f8f9fa;
        }

        .room-id {
            font-family: monospace;
            font-size: 12px;
            color: #7f8c8d;
        }

        .room-type {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .room-type.quick {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        .room-type.custom {
            background-color: #e3f2fd;
            color: #1565c0;
        }

        .player-count {
            font-weight: 600;
        }

        .player-count.full {
            color: #e74c3c;
        }

        .player-count.available {
            color: #27ae60;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-badge.in-progress {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-badge.waiting {
            background-color: #d1ecf1;
            color: #0c5460;
        }

        .status-badge.finished {
            background-color: #d4edda;
            color: #155724;
        }

        .details-toggle {
            cursor: pointer;
            color: #3498db;
            text-decoration: underline;
        }

        .details-toggle:hover {
            color: #2980b9;
        }

        .room-details {
            display: none;
        }

        .room-details.active {
            display: table-row;
        }

        .room-details td {
            padding: 0 !important;
            border: none !important;
        }

        .details-container {
            padding: 20px;
            background-color: #f8f9fa;
            border-top: 2px solid #3498db;
            margin: 0;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        @media (max-width: 1400px) {
            .details-container {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 1200px) {
            .details-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .details-container {
                grid-template-columns: 1fr;
            }
        }

        .details-section {
            background-color: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }

        .details-section h4 {
            margin: 0 0 12px 0;
            color: #2c3e50;
            font-size: 14px;
            font-weight: 600;
            padding-bottom: 8px;
            border-bottom: 2px solid #ecf0f1;
        }

        .details-section pre {
            background-color: #f5f5f5;
            padding: 12px;
            border-radius: 4px;
            overflow-x: auto;
            overflow-y: auto;
            max-height: 400px;
            font-size: 12px;
            line-height: 1.5;
            margin: 0;
            border: 1px solid #e0e0e0;
            white-space: pre-wrap;
            word-wrap: break-word;
            flex: 1;
            min-height: 0;
        }

        .details-section pre code {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .error {
            background-color: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .timestamp {
            color: #7f8c8d;
            font-size: 12px;
            margin-left: auto;
        }

        .filter-section {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .filter-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
        }

        .filter-group input[type="text"],
        .filter-group select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .filter-group input[type="text"] {
            min-width: 200px;
        }

        .users-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
        }

        .users-table th {
            background-color: #ecf0f1;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #bdc3c7;
        }

        .users-table td {
            padding: 12px;
            border-bottom: 1px solid #ecf0f1;
        }

        .users-table tr:hover {
            background-color: #f8f9fa;
        }

        .user-id {
            font-family: monospace;
            font-size: 12px;
            color: #7f8c8d;
        }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge.host {
            background-color: #fff3cd;
            color: #856404;
        }

        .badge.ready {
            background-color: #d4edda;
            color: #155724;
        }

        .badge.quick {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        .badge.custom {
            background-color: #e3f2fd;
            color: #1565c0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ç®¡ç†ç”»é¢ - ãƒ«ãƒ¼ãƒ ç®¡ç†</h1>

        <div class="stats-container" id="statsContainer">
            <div class="stat-card">
                <h3>ç·ãƒ«ãƒ¼ãƒ æ•°</h3>
                <div class="value" id="totalRooms">-</div>
            </div>
            <div class="stat-card">
                <h3>ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ«ãƒ¼ãƒ </h3>
                <div class="value" id="activeRooms">-</div>
            </div>
            <div class="stat-card">
                <h3>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼</h3>
                <div class="value" id="onlineUsers">-</div>
            </div>
            <div class="stat-card">
                <h3>æº€å“¡ãƒ«ãƒ¼ãƒ </h3>
                <div class="value" id="fullRooms">-</div>
            </div>
            <div class="stat-card">
                <h3>ç©ºããƒ«ãƒ¼ãƒ </h3>
                <div class="value" id="availableRooms">-</div>
            </div>
        </div>

        <div class="controls">
            <button id="refreshBtn" onclick="refreshData()">æ›´æ–°</button>
            <label>
                <input type="checkbox" id="autoRefreshToggle" onchange="toggleAutoRefresh()">
                è‡ªå‹•æ›´æ–°
            </label>
            <label>
                æ›´æ–°é–“éš”:
                <input type="number" id="refreshInterval" value="5" min="1" max="60">
                ç§’
            </label>
            <div class="timestamp" id="lastUpdate">æœ€çµ‚æ›´æ–°: -</div>
        </div>

        <div class="error" id="errorMessage" style="display: none;"></div>

        <div class="filter-section">
            <h3 style="margin-bottom: 15px; font-size: 16px;">ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°</h3>
            <div class="filter-group">
                <label>
                    ãƒ«ãƒ¼ãƒ ã‚¿ã‚¤ãƒ—:
                    <select id="roomTypeFilter">
                        <option value="">ã™ã¹ã¦</option>
                        <option value="quick">Quick Match</option>
                        <option value="custom">Custom</option>
                    </select>
                </label>
                <label>
                    çŠ¶æ…‹:
                    <select id="roomStatusFilter">
                        <option value="">ã™ã¹ã¦</option>
                        <option value="waiting">å¾…æ©Ÿä¸­</option>
                        <option value="in-progress">é€²è¡Œä¸­</option>
                        <option value="full">æº€å“¡</option>
                        <option value="available">ç©ºãã‚ã‚Š</option>
                    </select>
                </label>
                <label>
                    ãƒ«ãƒ¼ãƒ IDæ¤œç´¢:
                    <input type="text" id="roomIdFilter" placeholder="ãƒ«ãƒ¼ãƒ IDã§æ¤œç´¢">
                </label>
                <button onclick="clearFilters()" style="background-color: #95a5a6;">ãƒ•ã‚£ãƒ«ã‚¿ã‚¯ãƒªã‚¢</button>
            </div>
        </div>

        <div class="rooms-container">
            <h2 style="margin-bottom: 15px; font-size: 18px;">ãƒ«ãƒ¼ãƒ ä¸€è¦§</h2>
            <div id="loadingMessage" class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
            <div style="margin-bottom: 15px;">
                <button onclick="deleteSelectedRooms()" id="deleteSelectedBtn" style="background-color: #e74c3c;" disabled>é¸æŠã—ãŸãƒ«ãƒ¼ãƒ ã‚’å‰Šé™¤</button>
            </div>
            <table class="rooms-table" id="roomsTable" style="display: none;">
                <thead>
                    <tr>
                        <th style="width: 40px;">
                            <input type="checkbox" id="selectAllHeader" onchange="toggleSelectAllRooms()">
                        </th>
                        <th>ãƒ«ãƒ¼ãƒ ID</th>
                        <th>ã‚¿ã‚¤ãƒ—</th>
                        <th>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°</th>
                        <th>æœ€å¤§ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°</th>
                        <th>çŠ¶æ…‹</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="roomsTableBody">
                </tbody>
            </table>
        </div>

        <div class="users-container">
            <h2 style="margin-bottom: 15px; font-size: 18px;">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</h2>
            <div class="filter-section" style="margin-bottom: 15px; padding: 10px;">
                <div class="filter-group">
                    <label>
                        ãƒ¦ãƒ¼ã‚¶ãƒ¼IDæ¤œç´¢:
                        <input type="text" id="userIdFilter" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã§æ¤œç´¢">
                    </label>
                    <label>
                        ãƒ«ãƒ¼ãƒ ã‚¿ã‚¤ãƒ—:
                        <select id="userRoomTypeFilter">
                            <option value="">ã™ã¹ã¦</option>
                            <option value="quick">Quick Match</option>
                            <option value="custom">Custom</option>
                        </select>
                    </label>
                    <label>
                        ãƒ›ã‚¹ãƒˆã®ã¿:
                        <input type="checkbox" id="hostOnlyFilter">
                    </label>
                    <label>
                        Readyã®ã¿:
                        <input type="checkbox" id="readyOnlyFilter">
                    </label>
                    <button onclick="clearUserFilters()" style="background-color: #95a5a6;">ãƒ•ã‚£ãƒ«ã‚¿ã‚¯ãƒªã‚¢</button>
                </div>
            </div>
            <div id="usersLoadingMessage" class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
            <table class="users-table" id="usersTable" style="display: none;">
                <thead>
                    <tr>
                        <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼ID</th>
                        <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th>
                        <th>ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°</th>
                        <th>ãƒ«ãƒ¼ãƒ ID</th>
                        <th>ãƒ«ãƒ¼ãƒ ã‚¿ã‚¤ãƒ—</th>
                        <th>ãƒ«ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰</th>
                        <th>çŠ¶æ…‹</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let autoRefreshInterval = null;
        let serverUrl = 'https://rust.katsu996.workers.dev';
        let allRooms = [];
        let allUsers = [];

        // é–‹ç™ºç’°å¢ƒã®æ¤œå‡º
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            serverUrl = 'http://127.0.0.1:8787';
        }

        async function fetchStats() {
            try {
                const response = await fetch(`${serverUrl}/api/admin/stats`);
                if (!response.ok) {
                    let errorMessage = `HTTP error! status: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMessage += ` - ${JSON.stringify(errorData)}`;
                    } catch (e) {
                        const errorText = await response.text();
                        errorMessage += ` - ${errorText}`;
                    }
                    throw new Error(errorMessage);
                }
                const data = await response.json();
                updateStats(data);
            } catch (error) {
                console.error('Failed to fetch stats:', error);
                showError('çµ±è¨ˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        async function fetchRooms() {
            try {
                const response = await fetch(`${serverUrl}/api/admin/rooms`);
                if (!response.ok) {
                    let errorMessage = `HTTP error! status: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMessage += ` - ${JSON.stringify(errorData)}`;
                    } catch (e) {
                        const errorText = await response.text();
                        errorMessage += ` - ${errorText}`;
                    }
                    throw new Error(errorMessage);
                }
                const data = await response.json();
                allRooms = data.rooms || [];
                updateRooms(data);
                updateStatsFromRooms(data);
                applyRoomFilters();
            } catch (error) {
                console.error('Failed to fetch rooms:', error);
                showError('ãƒ«ãƒ¼ãƒ æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        async function fetchUsers() {
            try {
                const response = await fetch(`${serverUrl}/api/admin/users`);
                if (!response.ok) {
                    let errorMessage = `HTTP error! status: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMessage += ` - ${JSON.stringify(errorData)}`;
                    } catch (e) {
                        const errorText = await response.text();
                        errorMessage += ` - ${errorText}`;
                    }
                    throw new Error(errorMessage);
                }
                const data = await response.json();
                allUsers = data.users || [];
                applyUserFilters();
            } catch (error) {
                console.error('Failed to fetch users:', error);
                showError('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        function updateStats(stats) {
            document.getElementById('totalRooms').textContent = stats.totalRooms || 0;
            document.getElementById('activeRooms').textContent = stats.activeRooms || 0;
            document.getElementById('onlineUsers').textContent = stats.onlineUsers || 0;
            document.getElementById('fullRooms').textContent = stats.fullRooms || 0;
            document.getElementById('availableRooms').textContent = stats.availableRooms || 0;
        }

        function updateStatsFromRooms(data) {
            // ãƒ«ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰çµ±è¨ˆã‚’è¨ˆç®—
            const rooms = data.rooms || [];
            let fullRooms = 0;
            let availableRooms = 0;

            rooms.forEach(room => {
                const playerCount = room.playerCount || 0;
                const maxPlayers = room.maxPlayers || 0;
                if (playerCount >= maxPlayers && maxPlayers > 0) {
                    fullRooms++;
                } else if (playerCount < maxPlayers) {
                    availableRooms++;
                }
            });

            document.getElementById('fullRooms').textContent = fullRooms;
            document.getElementById('availableRooms').textContent = availableRooms;
        }

        function applyRoomFilters() {
            const roomTypeFilter = document.getElementById('roomTypeFilter').value;
            const roomStatusFilter = document.getElementById('roomStatusFilter').value;
            const roomIdFilter = document.getElementById('roomIdFilter').value.toLowerCase();

            let filteredRooms = allRooms.filter(room => {
                // ãƒ«ãƒ¼ãƒ ã‚¿ã‚¤ãƒ—ãƒ•ã‚£ãƒ«ã‚¿
                if (roomTypeFilter && room.matchType !== roomTypeFilter) {
                    return false;
                }

                // ãƒ«ãƒ¼ãƒ IDãƒ•ã‚£ãƒ«ã‚¿
                if (roomIdFilter && !room.roomId.toLowerCase().includes(roomIdFilter)) {
                    return false;
                }

                // çŠ¶æ…‹ãƒ•ã‚£ãƒ«ã‚¿
                if (roomStatusFilter) {
                    const playerCount = room.playerCount || 0;
                    const maxPlayers = room.maxPlayers || 0;
                    const isFull = playerCount >= maxPlayers && maxPlayers > 0;
                    const gameState = room.gameState || {};
                    const inProgress = gameState.inProgress || false;

                    if (roomStatusFilter === 'waiting' && (inProgress || playerCount === 0)) {
                        return false;
                    }
                    if (roomStatusFilter === 'in-progress' && !inProgress) {
                        return false;
                    }
                    if (roomStatusFilter === 'full' && !isFull) {
                        return false;
                    }
                    if (roomStatusFilter === 'available' && isFull) {
                        return false;
                    }
                }

                return true;
            });

            renderRooms(filteredRooms);
        }

        function renderRooms(rooms) {
            const tbody = document.getElementById('roomsTableBody');
            tbody.innerHTML = '';

            if (rooms.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #7f8c8d;">ãƒ«ãƒ¼ãƒ ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
                document.getElementById('roomsTable').style.display = 'table';
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('deleteSelectedBtn').disabled = true;
                return;
            }

            rooms.forEach((room, index) => {
                const row = document.createElement('tr');
                const playerCount = room.playerCount || 0;
                const maxPlayers = room.maxPlayers || 0;
                const isFull = playerCount >= maxPlayers && maxPlayers > 0;
                const gameState = room.gameState || {};
                const inProgress = gameState.inProgress || false;
                const detailsId = `details-${room.roomId}-${index}`;

                let statusBadge = '';
                if (inProgress) {
                    statusBadge = '<span class="status-badge in-progress">é€²è¡Œä¸­</span>';
                } else if (playerCount > 0) {
                    statusBadge = '<span class="status-badge waiting">å¾…æ©Ÿä¸­</span>';
                } else {
                    statusBadge = '<span class="status-badge finished">ç©ºã</span>';
                }

                row.innerHTML = `
                    <td>
                        <input type="checkbox" class="room-checkbox" value="${room.roomId}" onchange="updateDeleteButtonState()">
                    </td>
                    <td class="room-id">${room.roomId || 'N/A'}</td>
                    <td><span class="room-type ${room.matchType || 'unknown'}">${room.matchType === 'quick' ? 'Quick Match' : room.matchType === 'custom' ? 'Custom' : 'Unknown'}</span></td>
                    <td><span class="player-count ${isFull ? 'full' : 'available'}">${playerCount} / ${maxPlayers}</span></td>
                    <td>${maxPlayers}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <a href="#" class="details-toggle" onclick="toggleDetailsById('${detailsId}'); return false;">è©³ç´°</a>
                        <button onclick="deleteRoom('${room.roomId}')" style="margin-left: 10px; background-color: #e74c3c; padding: 5px 10px; font-size: 12px;">å‰Šé™¤</button>
                    </td>
                `;

                // è©³ç´°æƒ…å ±ã‚’è¿½åŠ 
                const detailsRow = document.createElement('tr');
                detailsRow.id = detailsId;
                detailsRow.className = 'room-details';
                detailsRow.innerHTML = `
                    <td colspan="8">
                        <div class="details-container">
                            <div class="details-section">
                                <h4>è¨­å®š</h4>
                                <pre><code>${JSON.stringify(room.settings || {}, null, 2)}</code></pre>
                            </div>
                            <div class="details-section">
                                <h4>ã‚²ãƒ¼ãƒ çŠ¶æ…‹</h4>
                                <pre><code>${JSON.stringify(room.gameState || {}, null, 2)}</code></pre>
                            </div>
                            <div class="details-section">
                                <h4>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±</h4>
                                <pre><code>${JSON.stringify(room.roomPlayers || [], null, 2)}</code></pre>
                            </div>
                            ${room.code ? `<div class="details-section"><h4>ãƒ«ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰</h4><pre><code>${room.code}</code></pre></div>` : ''}
                        </div>
                    </td>
                `;

                tbody.appendChild(row);
                tbody.appendChild(detailsRow);
            });

            document.getElementById('roomsTable').style.display = 'table';
            document.getElementById('loadingMessage').style.display = 'none';
            
            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            updateDeleteButtonState();
        }

        function updateRooms(data) {
            // ã“ã®é–¢æ•°ã¯å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ã«æ®‹ã™ãŒã€å®Ÿéš›ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã¯applyRoomFiltersã§è¡Œã†
            applyRoomFilters();
        }

        function applyUserFilters() {
            const userIdFilter = document.getElementById('userIdFilter').value.toLowerCase();
            const userRoomTypeFilter = document.getElementById('userRoomTypeFilter').value;
            const hostOnlyFilter = document.getElementById('hostOnlyFilter').checked;
            const readyOnlyFilter = document.getElementById('readyOnlyFilter').checked;

            let filteredUsers = allUsers.filter(user => {
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãƒ•ã‚£ãƒ«ã‚¿
                if (userIdFilter && !user.playerId.toLowerCase().includes(userIdFilter)) {
                    return false;
                }

                // ãƒ«ãƒ¼ãƒ ã‚¿ã‚¤ãƒ—ãƒ•ã‚£ãƒ«ã‚¿
                if (userRoomTypeFilter && user.matchType !== userRoomTypeFilter) {
                    return false;
                }

                // ãƒ›ã‚¹ãƒˆã®ã¿ãƒ•ã‚£ãƒ«ã‚¿
                if (hostOnlyFilter && !user.isHost) {
                    return false;
                }

                // Readyã®ã¿ãƒ•ã‚£ãƒ«ã‚¿
                if (readyOnlyFilter && !user.isReady) {
                    return false;
                }

                return true;
            });

            renderUsers(filteredUsers);
        }

        function renderUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';

            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #7f8c8d;">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
                document.getElementById('usersTable').style.display = 'table';
                document.getElementById('usersLoadingMessage').style.display = 'none';
                return;
            }

            users.forEach(user => {
                const row = document.createElement('tr');
                
                let badges = '';
                if (user.isHost) {
                    badges += '<span class="badge host">Host</span> ';
                }
                if (user.isReady) {
                    badges += '<span class="badge ready">Ready</span> ';
                }
                badges += `<span class="badge ${user.matchType}">${user.matchType === 'quick' ? 'Quick' : 'Custom'}</span>`;

                row.innerHTML = `
                    <td class="user-id">${user.playerId || 'N/A'}</td>
                    <td>${user.playerName || 'Unknown'}</td>
                    <td>${user.rating || 0}</td>
                    <td class="user-id">${user.roomId || 'N/A'}</td>
                    <td>${user.matchType === 'quick' ? 'Quick Match' : user.matchType === 'custom' ? 'Custom' : 'Unknown'}</td>
                    <td>${user.roomCode || '-'}</td>
                    <td>${badges}</td>
                `;

                tbody.appendChild(row);
            });

            document.getElementById('usersTable').style.display = 'table';
            document.getElementById('usersLoadingMessage').style.display = 'none';
        }

        function clearFilters() {
            document.getElementById('roomTypeFilter').value = '';
            document.getElementById('roomStatusFilter').value = '';
            document.getElementById('roomIdFilter').value = '';
            applyRoomFilters();
        }

        function clearUserFilters() {
            document.getElementById('userIdFilter').value = '';
            document.getElementById('userRoomTypeFilter').value = '';
            document.getElementById('hostOnlyFilter').checked = false;
            document.getElementById('readyOnlyFilter').checked = false;
            applyUserFilters();
        }

        function toggleDetails(index) {
            const details = document.getElementById(`details-${index}`);
            if (details) {
                details.classList.toggle('active');
            }
        }

        function toggleDetailsById(id) {
            const details = document.getElementById(id);
            if (details) {
                details.classList.toggle('active');
            }
        }

        function log(message, type = 'info') {
            // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ãƒ­ã‚°ã‚’å‡ºåŠ›
            if (type === 'error') {
                console.error(message);
            } else {
                console.log(message);
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function updateTimestamp() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = `æœ€çµ‚æ›´æ–°: ${now.toLocaleString('ja-JP')}`;
        }

        async function refreshData() {
            document.getElementById('loadingMessage').style.display = 'block';
            document.getElementById('roomsTable').style.display = 'none';
            document.getElementById('usersLoadingMessage').style.display = 'block';
            document.getElementById('usersTable').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';

            try {
                await Promise.all([fetchStats(), fetchRooms(), fetchUsers()]);
                updateTimestamp();
            } catch (error) {
                console.error('Refresh failed:', error);
            }
        }

        // ãƒ•ã‚£ãƒ«ã‚¿ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('roomTypeFilter').addEventListener('change', applyRoomFilters);
            document.getElementById('roomStatusFilter').addEventListener('change', applyRoomFilters);
            document.getElementById('roomIdFilter').addEventListener('input', applyRoomFilters);
            document.getElementById('userIdFilter').addEventListener('input', applyUserFilters);
            document.getElementById('userRoomTypeFilter').addEventListener('change', applyUserFilters);
            document.getElementById('hostOnlyFilter').addEventListener('change', applyUserFilters);
            document.getElementById('readyOnlyFilter').addEventListener('change', applyUserFilters);
        });

        function startAutoRefresh() {
            stopAutoRefresh();
            const interval = parseInt(document.getElementById('refreshInterval').value) * 1000;
            autoRefreshInterval = setInterval(() => {
                refreshData();
            }, interval);
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        function toggleAutoRefresh() {
            const toggle = document.getElementById('autoRefreshToggle');
            if (toggle.checked) {
                startAutoRefresh();
            } else {
                stopAutoRefresh();
            }
        }

        // æ›´æ–°é–“éš”å¤‰æ›´æ™‚ã«è‡ªå‹•æ›´æ–°ã‚’å†é–‹å§‹
        document.getElementById('refreshInterval').addEventListener('change', () => {
            if (document.getElementById('autoRefreshToggle').checked) {
                startAutoRefresh();
            }
        });

        // é¸æŠã•ã‚ŒãŸãƒ«ãƒ¼ãƒ ã‚’å–å¾—
        function getSelectedRooms() {
            const checkboxes = document.querySelectorAll('.room-checkbox:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        // å‰Šé™¤ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
        function updateDeleteButtonState() {
            const selectedRooms = getSelectedRooms();
            const deleteBtn = document.getElementById('deleteSelectedBtn');
            if (deleteBtn) {
                deleteBtn.disabled = selectedRooms.length === 0;
            }
        }

        // ã™ã¹ã¦é¸æŠ/è§£é™¤
        function toggleSelectAllRooms() {
            const selectAllHeader = document.getElementById('selectAllHeader');
            const checked = selectAllHeader ? selectAllHeader.checked : false;
            
            const checkboxes = document.querySelectorAll('.room-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = checked;
            });

            updateDeleteButtonState();
        }

        // é¸æŠã—ãŸãƒ«ãƒ¼ãƒ ã‚’ä¸€æ‹¬å‰Šé™¤
        async function deleteSelectedRooms() {
            const selectedRooms = getSelectedRooms();
            
            if (selectedRooms.length === 0) {
                alert('å‰Šé™¤ã™ã‚‹ãƒ«ãƒ¼ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            if (!confirm(`${selectedRooms.length}å€‹ã®ãƒ«ãƒ¼ãƒ ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
                return;
            }

            log(`ğŸ—‘ï¸ ${selectedRooms.length}å€‹ã®ãƒ«ãƒ¼ãƒ ã‚’å‰Šé™¤ä¸­...`, 'info');

            let successCount = 0;
            let failCount = 0;
            const errors = [];

            // ä¸¦åˆ—ã§å‰Šé™¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
            const deletePromises = selectedRooms.map(async (roomId) => {
                const apiUrl = `${serverUrl}/api/admin/rooms/${encodeURIComponent(roomId)}`;
                try {
                    const response = await fetch(apiUrl, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ error: { message: 'Unknown error' } }));
                        throw new Error(errorData.error?.message || 'Unknown error');
                    }

                    const data = await response.json();
                    log(`âœ… ãƒ«ãƒ¼ãƒ ã‚’å‰Šé™¤ã—ã¾ã—ãŸ: ${roomId}`, 'info');
                    return { success: true, roomId };
                } catch (error) {
                    log(`âŒ ãƒ«ãƒ¼ãƒ å‰Šé™¤ã‚¨ãƒ©ãƒ¼ (${roomId}): ${error.message}`, 'error');
                    return { success: false, roomId, error: error.message };
                }
            });

            const results = await Promise.all(deletePromises);
            
            results.forEach(result => {
                if (result.success) {
                    successCount++;
                } else {
                    failCount++;
                    errors.push(`${result.roomId}: ${result.error}`);
                }
            });

            // çµæœã‚’è¡¨ç¤º
            if (failCount === 0) {
                alert(`${successCount}å€‹ã®ãƒ«ãƒ¼ãƒ ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
            } else {
                alert(`${successCount}å€‹ã®ãƒ«ãƒ¼ãƒ ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚\n${failCount}å€‹ã®ãƒ«ãƒ¼ãƒ ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ:\n${errors.join('\n')}`);
            }

            // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
            await refreshData();
        }

        // ãƒ«ãƒ¼ãƒ å‰Šé™¤é–¢æ•°ï¼ˆå€‹åˆ¥å‰Šé™¤ç”¨ï¼‰
        async function deleteRoom(roomId) {
            if (!confirm(`ãƒ«ãƒ¼ãƒ  "${roomId}" ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
                return;
            }

            const apiUrl = `${serverUrl}/api/admin/rooms/${encodeURIComponent(roomId)}`;
            log(`ğŸ—‘ï¸ ãƒ«ãƒ¼ãƒ å‰Šé™¤ä¸­: ${apiUrl}`, 'info');

            try {
                const response = await fetch(apiUrl, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: { message: 'Unknown error' } }));
                    log(`âŒ å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ${JSON.stringify(errorData)}`, 'error');
                    alert(`ãƒ«ãƒ¼ãƒ ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ${errorData.error?.message || 'Unknown error'}`);
                    return;
                }

                const data = await response.json();
                log(`âœ… ãƒ«ãƒ¼ãƒ ã‚’å‰Šé™¤ã—ã¾ã—ãŸ: ${JSON.stringify(data)}`, 'info');
                alert('ãƒ«ãƒ¼ãƒ ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');

                // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
                await refreshData();
            } catch (error) {
                log(`âŒ å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                alert(`ãƒ«ãƒ¼ãƒ ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
            }
        }

        // åˆå›èª­ã¿è¾¼ã¿
        refreshData();
    </script>
</body>
</html>

